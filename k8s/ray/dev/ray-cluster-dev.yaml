# ============================================================================
# Ray Cluster - Development Environment
# ============================================================================
# Minimal Ray cluster for testing and development
#
# Resources:
# - Head node: 1Gi memory, 500m CPU
# - Workers: 2 replicas, 1.2Gi memory each
# - No persistent storage
# - Autoscaling disabled
#
# Usage:
#   kubectl apply -f k8s/ray/dev/ray-cluster-dev.yaml
#   kubectl port-forward -n ray-dev svc/ray-cluster-dev-head-svc 8265:8265
#   # Access dashboard at http://localhost:8265
# ============================================================================

---
apiVersion: v1
kind: Namespace
metadata:
  name: ray-dev
  labels:
    name: ray-dev

---
apiVersion: ray.io/v1alpha1
kind: RayCluster
metadata:
  name: ray-cluster-dev
  namespace: ray-dev
  labels:
    environment: development
    app: ray-cluster
spec:
  rayVersion: "2.9.0"

  # ============================================================================
  # Head Node Configuration
  # ============================================================================
  headGroupSpec:
    replicas: 1
    rayStartParams:
      dashboard-host: "0.0.0.0"
      num-cpus: "0"  # Don't schedule tasks on head node
      metrics-export-port: "8080"

    template:
      metadata:
        labels:
          app: ray-head
          environment: development
      spec:
        containers:
        - name: ray-head
          image: rayproject/ray-ml:2.9.0
          imagePullPolicy: IfNotPresent

          resources:
            limits:
              cpu: 500m
              memory: 1Gi
            requests:
              cpu: 500m
              memory: 1Gi

          ports:
          - containerPort: 6379
            name: gcs
            protocol: TCP
          - containerPort: 8265
            name: dashboard
            protocol: TCP
          - containerPort: 10001
            name: client
            protocol: TCP
          - containerPort: 8000
            name: serve
            protocol: TCP
          - containerPort: 8080
            name: metrics
            protocol: TCP

          env:
          - name: RAY_GRAFANA_IFRAME_HOST
            value: "http://localhost:3000"
          - name: RAY_GRAFANA_HOST
            value: "http://prometheus-grafana.monitoring:80"
          - name: RAY_PROMETHEUS_HOST
            value: "http://prometheus-kube-prometheus-prometheus.monitoring:9090"

          livenessProbe:
            httpGet:
              path: /api/version
              port: dashboard
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /api/version
              port: dashboard
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3

  # ============================================================================
  # Worker Node Configuration
  # ============================================================================
  workerGroupSpecs:
  - groupName: inference-routers
    replicas: 2
    minReplicas: 1
    maxReplicas: 2  # No autoscaling in dev

    rayStartParams:
      num-cpus: "1"
      metrics-export-port: "8080"

    template:
      metadata:
        labels:
          app: ray-worker
          group: inference-routers
          environment: development
      spec:
        containers:
        - name: ray-worker
          image: rayproject/ray-ml:2.9.0
          imagePullPolicy: IfNotPresent

          resources:
            limits:
              cpu: 500m
              memory: 1.2Gi
            requests:
              cpu: 500m
              memory: 1.2Gi

          env:
          - name: RAY_object_store_memory
            value: "400000000"  # 400Mi for object store (33% of 1.2Gi)

          livenessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - "ray health-check --address $(hostname):6379 || exit 1"
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
