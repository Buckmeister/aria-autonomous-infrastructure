# cert-manager ClusterIssuer for Let's Encrypt
# Automatically provisions and renews TLS certificates

---
# Let's Encrypt Staging Issuer (for testing)
# Use this first to test your setup without hitting rate limits
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Staging server - issues untrusted certificates for testing
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    # Email for certificate expiration notifications
    email: your-email@example.com  # CHANGE THIS
    # Secret to store ACME account private key
    privateKeySecretRef:
      name: letsencrypt-staging-key
    # HTTP-01 challenge (requires public DNS and ingress)
    solvers:
      - http01:
          ingress:
            class: nginx

---
# Let's Encrypt Production Issuer
# Use this after testing with staging issuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Production server - issues trusted certificates
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email for certificate expiration notifications
    email: your-email@example.com  # CHANGE THIS
    # Secret to store ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod-key
    # HTTP-01 challenge (requires public DNS and ingress)
    solvers:
      - http01:
          ingress:
            class: nginx

---
# Note: cert-manager Prerequisites
#
# 1. Install cert-manager:
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. Verify installation:
#    kubectl get pods -n cert-manager
#
# 3. Update email address in both ClusterIssuers above
#
# 4. Apply this file:
#    kubectl apply -f cert-issuer.yaml
#
# 5. Update your Ingress to use the issuer:
#    metadata:
#      annotations:
#        cert-manager.io/cluster-issuer: "letsencrypt-staging"  # Test first
#        # Then switch to: "letsencrypt-prod"
#
# 6. cert-manager will automatically:
#    - Request a certificate from Let's Encrypt
#    - Complete the HTTP-01 challenge
#    - Store the certificate in the specified secret
#    - Automatically renew before expiration
#
# Testing with Staging:
# - Staging certificates are NOT trusted by browsers
# - Use staging first to avoid production rate limits (5 certs/week/domain)
# - Once working, switch annotation to "letsencrypt-prod"
#
# Troubleshooting:
# - Check cert-manager logs: kubectl logs -n cert-manager deployment/cert-manager
# - Check certificate status: kubectl describe certificate rocket-ollama-tls -n rocket
# - Check order/challenge: kubectl get orders,challenges -n rocket
